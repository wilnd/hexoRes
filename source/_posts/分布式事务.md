---
title: 分布式事务
date: 2018-12-04 11:00:50
tags: java 事务
categories: java
---
#### 分布式事务

```
一次大操作由不同小操作组成,这些小操作分布在不同的服务器上,
分布式事务要保证这些小操作要么全成功,要么全失败.
说的更官方一点,分布式事务就是保证不同数据库或消息系统的数据一致性.
```
##### 分布式事务三大难题
- 一致性
```
在各种异常的情况下,保证数据是强一致的.
目前最常用的一致性解决方案是最终一致性方案.
```
- 高性能
```
目前基于XA协议两阶段提交,是最常用的分布式事务解决方案,但是性能低下,开启分布式事务后,吞吐量有数量级下降
```
- 易用性
```
为满足一致性和高性能要求,会出现特定场景下的分布式事务方案,但一般会限制用户用法,对业务入侵性强.
```
##### 分布式事务传统解决方案 2阶段提交

```
内容:
参与者将操作成败通知协调者
协调者根据各参与者的反馈,决定提交操作或者中止操作
利弊:
不仅锁住所有者资源,还要锁住调用者资源
```
##### 柔性事务

```
一个操作由两个事务A,B组成,如果A事务执行完A提交
如不哦事务B执行完B提交,如果B执行失败,B回滚,并对已提交的事务A做补偿反操作.
业务入侵性太强.
```
##### 消息最终一致性解决方案RocketMQ/RbbitMQ

```
只要消息发送,就能确保消费者消费,来做到消息最终一致性
消息确认机制:
1. 生产者发送消息到消息服务
2. 如果消息落地持久化完成,返回一个标志给生产者.生产者拿到这个确认后,才能放心的说这个消息成功发送,否则进入异常处理流程.
3. 消息服务将消息发送给消费者
4. 消费者消费并处理消息,当消费服务拿到这个确认后,消费流程走完,否则走异常流程
消息异常:
1. 直接无法达到消息服务器,例如断网.
    处理方案:业务直接回滚.
2. 消息已达到服务器,但返回时出现异常.
    处理方案:ack机制,发送前,在db中存一下消息,如果ack异常,则重发
3. 消息到达后,消息服务自己挂了
    如果设置了持久化,ack成功是在持久化后发生的,所以系统挂了,ack是false,重启系统后会自动重发AC消息
4. 未送达消费者
    消息服务会一直重试,知道客户端确认消息
5. 确认消息丢失
    消息服务会重发消息
6. 消费者业务处理异常
    重复执行异常业务

```
##### GTS 全局事务服务(牛逼,不开源)
GTS事务通过RPC框架,和消息中间件进行事务传递,把整个业务链路或消息链路串成一个分布式事务,极大简化应用开发.
```
客户端:
    负责界定事务边界,开启/提交/回滚全局事务
事务协调器:
    也就是GTS服务器,负责协调整个事务过程.
资源管理器:
    负责管理资源,支持资源包括DRDS,Oracle,Mysql,RDS,PostgreSQL,H2,MQ
```


